{% extends 'admin/base.html' %}

{% block title %}Student Details{% endblock %}

{% block styles %}
<style>
    .student-header {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .student-photo {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .student-name {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .student-rank {
        font-size: 1.2rem;
        color: #6c757d;
        margin-bottom: 15px;
    }

    .student-info {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .info-item {
        background-color: white;
        border-radius: 8px;
        padding: 10px 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .info-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .info-value {
        font-weight: 600;
    }

    .detail-card {
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .detail-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        padding: 15px 20px;
    }

    .detail-card .card-title {
        margin-bottom: 0;
        font-weight: 600;
    }

    .detail-row {
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #6c757d;
    }

    .action-buttons {
        position: sticky;
        bottom: 20px;
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 100;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.students') }}">Students</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Student Details</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <a href="{{ url_for('admin.print_student', student_id=student.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-print"></i> Print Profile
                </a>
                <a href="{{ url_for('admin.download_student_documents', student_id=student.id) }}" class="btn btn-outline-success">
                    <i class="fas fa-download"></i> Download Documents
                </a>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteStudentModal">
                    <i class="fas fa-trash"></i> Delete Student
                </button>
            </div>
        </div>
    </div>

    <!-- Student Header -->
    <div class="student-header">
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                {% if student.passport_photo %}
                <img src="{{ url_for('static', filename='uploads/passport_photos/' + student.passport_photo) }}" class="student-photo" alt="Student Photo">
                {% else %}
                <img src="{{ url_for('static', filename='images/placeholder-user.png') }}" class="student-photo" alt="Student Photo">
                {% endif %}
                <div class="mt-2">
                    <span class="badge {% if student.is_portal_registered %}bg-success{% else %}bg-secondary{% endif %} p-2">
                        {% if student.is_portal_registered %}
                            <i class="fas fa-check-circle me-1"></i> Portal Registered
                        {% else %}
                            <i class="fas fa-times-circle me-1"></i> Not Registered
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <h1 class="student-name">{{ student.surname }}, {{ student.other_names }}</h1>
                <div class="student-rank">{{ student.rank }}</div>
                <div class="student-info">
                    <div class="info-item">
                        <div class="info-label">Service Number</div>
                        <div class="info-value">{{ student.service_number }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Current Unit</div>
                        <div class="info-value">{{ student.current_unit }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Years in Service</div>
                        <div class="info-value">{{ student.years_in_service }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Corps</div>
                        <div class="info-value">{{ student.corps or 'Not Assigned' }}</div>
                    </div>
                    {% if student.email %}
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value">{{ student.email }}</div>
                    </div>
                    {% endif %}
                    {% if student.phone %}
                    <div class="info-item">
                        <div class="info-label">Phone</div>
                        <div class="info-value">{{ student.phone }}</div>
                    </div>
                    {% endif %}
                    {% if student.last_login %}
                    <div class="info-item">
                        <div class="info-label">Last Login</div>
                        <div class="info-value">{{ student.last_login }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Quick Actions</h5>
                        <div class="list-group list-group-flush">
                            <a href="{{ url_for('admin.edit_student', student_id=student.id) }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-edit me-2"></i> Edit Student Information
                            </a>
                            <a href="{{ url_for('admin.print_student', student_id=student.id) }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-print me-2"></i> Print Profile
                            </a>
                            <a href="{{ url_for('admin.download_student_documents', student_id=student.id) }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-download me-2"></i> Download All Documents
                            </a>
                            {% if student.is_portal_registered %}
                            <a href="{{ url_for('admin.reset_student_password', student_id=student.id) }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-key me-2"></i> Reset Portal Password
                            </a>
                            <a href="{{ url_for('admin.toggle_student_account', student_id=student.id) }}" class="list-group-item list-group-item-action">
                                {% if student.account_status == 'active' %}
                                <i class="fas fa-user-slash me-2"></i> Deactivate Account
                                {% else %}
                                <i class="fas fa-user-check me-2"></i> Activate Account
                                {% endif %}
                            </a>
                            {% else %}
                            <a href="{{ url_for('admin.create_student_portal', student_id=student.id) }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-user-plus me-2"></i> Create Portal Account
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Personal Information -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-user me-2"></i> Personal Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Full Name</div>
                        <div class="col-md-8">{{ student.surname }}, {{ student.other_names }}</div>
                    </div>
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Service Number</div>
                        <div class="col-md-8">{{ student.service_number }}</div>
                    </div>
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Rank</div>
                        <div class="col-md-8">{{ student.rank }}</div>
                    </div>
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Gender</div>
                        <div class="col-md-8">{{ student.gender }}</div>
                    </div>
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Date of Birth</div>
                        <div class="col-md-8">{{ student.date_of_birth }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Military Information -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-shield-alt me-2"></i> Military Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Current Unit</div>
                        <div class="col-md-8">{{ student.current_unit }}</div>
                    </div>
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Date of Commission</div>
                        <div class="col-md-8">{{ student.date_of_commission }}</div>
                    </div>
                    <div class="row detail-row">
                        <div class="col-md-4 detail-label">Years in Service</div>
                        <div class="col-md-8">{{ student.years_in_service }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- NASS Course History -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-graduation-cap me-2"></i> NASS Course History
                    </h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignCourseModal">
                        <i class="fas fa-plus-circle me-1"></i> Assign Course
                    </button>
                </div>
                <div class="card-body">
                    {% if student_courses %}
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Course Name</th>
                                        <th>Status</th>
                                        <th>Registration Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for course in student_courses %}
                                    <tr>
                                        <td>{{ course.name }}</td>
                                        <td>
                                            <span class="badge {% if course.status == 'completed' %}bg-success{% elif course.status == 'in_progress' %}bg-primary{% else %}bg-secondary{% endif %}">
                                                {{ course.status|capitalize }}
                                            </span>
                                        </td>
                                        <td>{{ course.registration_date }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editCourseStatusModal"
                                                        data-course-id="{{ course.id }}" data-course-name="{{ course.name }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% if course.status == 'completed' and not course.has_certificate %}
                                                <a href="{{ url_for('admin.upload_certificate', student_id=student.id, course_id=course.id) }}" class="btn btn-outline-success">
                                                    <i class="fas fa-certificate"></i>
                                                </a>
                                                {% endif %}
                                                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#removeCourseModal"
                                                        data-course-id="{{ course.id }}" data-course-name="{{ course.name }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No NASS course history available for this student.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Other Military Courses -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-medal me-2"></i> Other Military Courses
                    </h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addMilitaryCourseModal">
                        <i class="fas fa-plus-circle me-1"></i> Add Course
                    </button>
                </div>
                <div class="card-body">
                    {% if military_courses %}
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Course Name</th>
                                        <th>Institution</th>
                                        <th>Year</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for course in military_courses %}
                                    <tr>
                                        <td>{{ course.institution_name }}</td>
                                        <td>{{ course.certificate }}</td>
                                        <td>{{ course.end_date }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editMilitaryCourseModal"
                                                        data-course-id="{{ course.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#removeMilitaryCourseModal"
                                                        data-course-id="{{ course.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No other military course history available for this student.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Certificates -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-certificate me-2"></i> Certificates
                    </h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadCertificateModal">
                        <i class="fas fa-upload me-1"></i> Upload Certificate
                    </button>
                </div>
                <div class="card-body">
                    {% if certificates %}
                        <div class="list-group">
                            {% for cert in certificates %}
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ cert.course_name }}</h6>
                                        <small>{{ cert.issue_date }}</small>
                                    </div>
                                    <p class="mb-1">Certificate #: {{ cert.certificate_number }}</p>
                                    <div class="d-flex justify-content-end">
                                        <a href="{{ url_for('admin.view_certificate', certificate_id=cert.id) }}" class="btn btn-sm btn-outline-primary me-2" target="_blank">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        <a href="{{ url_for('admin.download_certificate', certificate_id=cert.id) }}" class="btn btn-sm btn-outline-success me-2">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#removeCertificateModal"
                                                data-certificate-id="{{ cert.id }}" data-course-name="{{ cert.course_name }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No certificates available for this student.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div class="col-md-6">
            <div class="card detail-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i> Uploaded Documents
                    </h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                        <i class="fas fa-upload me-1"></i> Upload Document
                    </button>
                </div>
                <div class="card-body">
                    {% if student_documents %}
                        <div class="list-group">
                            {% for doc in student_documents %}
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ doc.requirement_name }}</h6>
                                        <small>{{ (doc.file_size / 1024)|round(1) }} KB</small>
                                    </div>
                                    <p class="mb-1">{{ doc.original_filename }}</p>
                                    <div class="d-flex justify-content-end">
                                        <a href="{{ url_for('admin.view_document', document_id=doc.id) }}" class="btn btn-sm btn-outline-primary me-2" target="_blank">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        <a href="{{ url_for('admin.download_document', document_id=doc.id) }}" class="btn btn-sm btn-outline-success me-2">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#removeDocumentModal"
                                                data-document-id="{{ doc.id }}" data-document-name="{{ doc.original_filename }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No documents uploaded for this student.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Student Portal Information -->
    <div class="row">
        <div class="col-12">
            <div class="card detail-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-user-shield me-2"></i> Student Portal Information
                    </h5>
                </div>
                <div class="card-body">
                    {% if student.is_portal_registered %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Account Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row detail-row">
                                            <div class="col-md-4 detail-label">Email</div>
                                            <div class="col-md-8">{{ student.email or 'Not provided' }}</div>
                                        </div>
                                        <div class="row detail-row">
                                            <div class="col-md-4 detail-label">Phone</div>
                                            <div class="col-md-8">{{ student.phone or 'Not provided' }}</div>
                                        </div>
                                        <div class="row detail-row">
                                            <div class="col-md-4 detail-label">Status</div>
                                            <div class="col-md-8">
                                                <span class="badge {% if student.account_status == 'active' %}bg-success{% else %}bg-danger{% endif %}">
                                                    {{ student.account_status|capitalize }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row detail-row">
                                            <div class="col-md-4 detail-label">Last Login</div>
                                            <div class="col-md-8">{{ student.last_login or 'Never logged in' }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Login History</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if login_history %}
                                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                <table class="table table-sm table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Date & Time</th>
                                                            <th>IP Address</th>
                                                            <th>Device</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for login in login_history %}
                                                        <tr>
                                                            <td>{{ login.login_time }}</td>
                                                            <td>{{ login.ip_address }}</td>
                                                            <td>{{ login.user_agent|truncate(30) }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i> No login history available.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i> This student has not registered for the student portal.
                        </div>
                        <div class="text-center">
                            <a href="{{ url_for('admin.create_student_portal', student_id=student.id) }}" class="btn btn-primary">
                                <i class="fas fa-user-plus me-2"></i> Create Portal Account
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons text-center">
        <a href="{{ url_for('admin.edit_student', student_id=student.id) }}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i> Edit Student Information
        </a>
    </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Student Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="service_number" class="form-label">Service Number</label>
                            <input type="text" class="form-control" id="service_number" value="{{ student.service_number }}">
                        </div>
                        <div class="col-md-6">
                            <label for="rank" class="form-label">Rank</label>
                            <select class="form-select" id="rank">
                                <!-- Non-Commissioned Officers -->
                                <option value="Private" {% if student.rank == 'Private' %}selected{% endif %}>Private</option>
                                <option value="Lance Corporal" {% if student.rank == 'Lance Corporal' %}selected{% endif %}>Lance Corporal</option>
                                <option value="Corporal" {% if student.rank == 'Corporal' %}selected{% endif %}>Corporal</option>
                                <option value="Sergeant" {% if student.rank == 'Sergeant' %}selected{% endif %}>Sergeant</option>
                                <option value="Staff Sergeant" {% if student.rank == 'Staff Sergeant' %}selected{% endif %}>Staff Sergeant</option>
                                <option value="Warrant Officer" {% if student.rank == 'Warrant Officer' %}selected{% endif %}>Warrant Officer</option>
                                <option value="Master Warrant Officer" {% if student.rank == 'Master Warrant Officer' %}selected{% endif %}>Master Warrant Officer</option>
                                <option value="Army Warrant Officer" {% if student.rank == 'Army Warrant Officer' %}selected{% endif %}>Army Warrant Officer</option>

                                <!-- Commissioned Officers -->
                                <option value="Second Lieutenant" {% if student.rank == 'Second Lieutenant' %}selected{% endif %}>Second Lieutenant</option>
                                <option value="Lieutenant" {% if student.rank == 'Lieutenant' %}selected{% endif %}>Lieutenant</option>
                                <option value="Captain" {% if student.rank == 'Captain' %}selected{% endif %}>Captain</option>
                                <option value="Major" {% if student.rank == 'Major' %}selected{% endif %}>Major</option>
                                <option value="Lieutenant Colonel" {% if student.rank == 'Lieutenant Colonel' %}selected{% endif %}>Lieutenant Colonel</option>
                                <option value="Colonel" {% if student.rank == 'Colonel' %}selected{% endif %}>Colonel</option>
                                <option value="Brigadier General" {% if student.rank == 'Brigadier General' %}selected{% endif %}>Brigadier General</option>
                                <option value="Major General" {% if student.rank == 'Major General' %}selected{% endif %}>Major General</option>
                                <option value="Lieutenant General" {% if student.rank == 'Lieutenant General' %}selected{% endif %}>Lieutenant General</option>
                                <option value="General" {% if student.rank == 'General' %}selected{% endif %}>General</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="surname" class="form-label">Surname</label>
                            <input type="text" class="form-control" id="surname" value="{{ student.surname }}">
                        </div>
                        <div class="col-md-6">
                            <label for="other_names" class="form-label">Other Names</label>
                            <input type="text" class="form-control" id="other_names" value="{{ student.other_names }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender">
                                <option value="Male" {% if student.gender == 'Male' %}selected{% endif %}>Male</option>
                                <option value="Female" {% if student.gender == 'Female' %}selected{% endif %}>Female</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="date_of_birth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="date_of_birth" value="{{ student.date_of_birth }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="corps" class="form-label">Corps</label>
                            <select class="form-select" id="corps">
                                <option value="" {% if not student.corps %}selected{% endif %}>Select Corps</option>
                                <option value="Infantry" {% if student.corps == 'Infantry' %}selected{% endif %}>Infantry Corps</option>
                                <option value="Artillery" {% if student.corps == 'Artillery' %}selected{% endif %}>Artillery Corps</option>
                                <option value="Armour" {% if student.corps == 'Armour' %}selected{% endif %}>Armour Corps</option>
                                <option value="Signals" {% if student.corps == 'Signals' %}selected{% endif %}>Signals Corps</option>
                                <option value="Engineers" {% if student.corps == 'Engineers' %}selected{% endif %}>Engineers Corps</option>
                                <option value="Supply and Transport" {% if student.corps == 'Supply and Transport' %}selected{% endif %}>Supply and Transport Corps</option>
                                <option value="Military Police" {% if student.corps == 'Military Police' %}selected{% endif %}>Military Police Corps</option>
                                <option value="Intelligence" {% if student.corps == 'Intelligence' %}selected{% endif %}>Intelligence Corps</option>
                                <option value="Medical" {% if student.corps == 'Medical' %}selected{% endif %}>Medical Corps</option>
                                <option value="Electrical and Mechanical Engineers" {% if student.corps == 'Electrical and Mechanical Engineers' %}selected{% endif %}>Electrical and Mechanical Engineers</option>
                                <option value="Education" {% if student.corps == 'Education' %}selected{% endif %}>Education Corps</option>
                                <option value="Finance" {% if student.corps == 'Finance' %}selected{% endif %}>Finance Corps</option>
                                <option value="Ordnance" {% if student.corps == 'Ordnance' %}selected{% endif %}>Ordnance Corps</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="current_unit" class="form-label">Current Unit</label>
                            <input type="text" class="form-control" id="current_unit" value="{{ student.current_unit }}">
                        </div>
                        <div class="col-md-4">
                            <label for="date_of_commission" class="form-label">Date of Commission</label>
                            <input type="date" class="form-control" id="date_of_commission" value="{{ student.date_of_commission }}">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Student Modal -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> Warning: This action cannot be undone.
                </div>
                <p>Are you sure you want to delete the following student?</p>
                <p><strong>{{ student.surname }}, {{ student.other_names }}</strong> ({{ student.service_number }})</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Student</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Course Modal -->
<div class="modal fade" id="assignCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.assign_course', student_id=student.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="course_id" class="form-label">Select Course</label>
                        <select class="form-select" id="course_id" name="course_id" required>
                            <option value="">-- Select a course --</option>
                            {% for course in available_courses %}
                            <option value="{{ course.id }}">{{ course.name }} ({{ course.quarter }} {{ course.year }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="registered">Registered</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="dropped">Dropped</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="registration_date" class="form-label">Registration Date</label>
                        <input type="date" class="form-control" id="registration_date" name="registration_date" value="{{ now.strftime('%Y-%m-%d') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="remarks" name="remarks" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Course Status Modal -->
<div class="modal fade" id="editCourseStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Course Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.update_course_status', student_id=student.id) }}" method="POST">
                <input type="hidden" id="edit_course_id" name="course_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Course</label>
                        <div id="edit_course_name" class="form-control-plaintext"></div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_status" class="form-label">Status</label>
                        <select class="form-select" id="edit_status" name="status" required>
                            <option value="registered">Registered</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="dropped">Dropped</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="completion_date" class="form-label">Completion Date</label>
                        <input type="date" class="form-control" id="completion_date" name="completion_date">
                        <div class="form-text">Required only if status is "Completed"</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_grade" class="form-label">Grade</label>
                        <input type="text" class="form-control" id="edit_grade" name="grade">
                    </div>
                    <div class="mb-3">
                        <label for="edit_remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="edit_remarks" name="remarks" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Remove Course Modal -->
<div class="modal fade" id="removeCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.remove_course', student_id=student.id) }}" method="POST">
                <input type="hidden" id="remove_course_id" name="course_id">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> Warning: This action cannot be undone.
                    </div>
                    <p>Are you sure you want to remove the following course from this student's record?</p>
                    <p><strong id="remove_course_name"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Remove Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Military Course Modal -->
<div class="modal fade" id="addMilitaryCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Military Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.add_military_course', student_id=student.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="serial_number" class="form-label">Serial Number</label>
                        <input type="text" class="form-control" id="serial_number" name="serial_number">
                    </div>
                    <div class="mb-3">
                        <label for="institution_name" class="form-label">Institution Name</label>
                        <input type="text" class="form-control" id="institution_name" name="institution_name" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="month" class="form-control" id="start_date" name="start_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="month" class="form-control" id="end_date" name="end_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="certificate" class="form-label">Certificate</label>
                        <input type="text" class="form-control" id="certificate" name="certificate" required>
                    </div>
                    <div class="mb-3">
                        <label for="grade" class="form-label">Grade</label>
                        <input type="text" class="form-control" id="grade" name="grade" required>
                    </div>
                    <div class="mb-3">
                        <label for="remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="remarks" name="remarks" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Military Course Modal -->
<div class="modal fade" id="editMilitaryCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Military Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.update_military_course', student_id=student.id) }}" method="POST">
                <input type="hidden" id="edit_military_course_id" name="course_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_serial_number" class="form-label">Serial Number</label>
                        <input type="text" class="form-control" id="edit_serial_number" name="serial_number">
                    </div>
                    <div class="mb-3">
                        <label for="edit_institution_name" class="form-label">Institution Name</label>
                        <input type="text" class="form-control" id="edit_institution_name" name="institution_name" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_start_date" class="form-label">Start Date</label>
                            <input type="month" class="form-control" id="edit_start_date" name="start_date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_end_date" class="form-label">End Date</label>
                            <input type="month" class="form-control" id="edit_end_date" name="end_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_certificate" class="form-label">Certificate</label>
                        <input type="text" class="form-control" id="edit_certificate" name="certificate" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_grade" class="form-label">Grade</label>
                        <input type="text" class="form-control" id="edit_grade" name="grade" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="edit_remarks" name="remarks" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Remove Military Course Modal -->
<div class="modal fade" id="removeMilitaryCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Military Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.remove_military_course', student_id=student.id) }}" method="POST">
                <input type="hidden" id="remove_military_course_id" name="course_id">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> Warning: This action cannot be undone.
                    </div>
                    <p>Are you sure you want to remove this military course from the student's record?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Remove Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Certificate Modal -->
<div class="modal fade" id="uploadCertificateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Certificate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.upload_certificate_manual', student_id=student.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="certificate_course_id" class="form-label">Select Course</label>
                        <select class="form-select" id="certificate_course_id" name="course_id" required>
                            <option value="">-- Select a course --</option>
                            {% for course in completed_courses %}
                            <option value="{{ course.id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_file" class="form-label">Certificate File</label>
                        <input type="file" class="form-control" id="certificate_file" name="certificate_file" accept=".pdf,.jpg,.jpeg,.png" required>
                    </div>
                    <div class="mb-3">
                        <label for="issue_date" class="form-label">Issue Date</label>
                        <input type="date" class="form-control" id="issue_date" name="issue_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_number" class="form-label">Certificate Number</label>
                        <input type="text" class="form-control" id="certificate_number" name="certificate_number">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload Certificate</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Remove Certificate Modal -->
<div class="modal fade" id="removeCertificateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Certificate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.remove_certificate', student_id=student.id) }}" method="POST">
                <input type="hidden" id="remove_certificate_id" name="certificate_id">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> Warning: This action cannot be undone.
                    </div>
                    <p>Are you sure you want to remove the certificate for:</p>
                    <p><strong id="remove_certificate_course"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Remove Certificate</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.upload_document', student_id=student.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="requirement_id" class="form-label">Document Type</label>
                        <select class="form-select" id="requirement_id" name="requirement_id" required>
                            <option value="">-- Select document type --</option>
                            {% for req in document_requirements %}
                            <option value="{{ req.id }}">{{ req.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="document_file" class="form-label">Document File</label>
                        <input type="file" class="form-control" id="document_file" name="document_file" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload Document</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Remove Document Modal -->
<div class="modal fade" id="removeDocumentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.remove_document', student_id=student.id) }}" method="POST">
                <input type="hidden" id="remove_document_id" name="document_id">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> Warning: This action cannot be undone.
                    </div>
                    <p>Are you sure you want to remove the following document?</p>
                    <p><strong id="remove_document_name"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Remove Document</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Print functionality
        const printBtn = document.getElementById('printBtn');
        if (printBtn) {
            printBtn.addEventListener('click', function() {
                window.print();
            });
        }

        // Delete student functionality
        const confirmDelete = document.getElementById('confirmDelete');
        if (confirmDelete) {
            confirmDelete.addEventListener('click', function() {
                window.location.href = "{{ url_for('admin.delete_student', student_id=student.id) }}";
            });
        }

        // Course status modal
        const editCourseStatusModal = document.getElementById('editCourseStatusModal');
        if (editCourseStatusModal) {
            editCourseStatusModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const courseId = button.getAttribute('data-course-id');
                const courseName = button.getAttribute('data-course-name');

                document.getElementById('edit_course_id').value = courseId;
                document.getElementById('edit_course_name').textContent = courseName;
            });
        }

        // Remove course modal
        const removeCourseModal = document.getElementById('removeCourseModal');
        if (removeCourseModal) {
            removeCourseModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const courseId = button.getAttribute('data-course-id');
                const courseName = button.getAttribute('data-course-name');

                document.getElementById('remove_course_id').value = courseId;
                document.getElementById('remove_course_name').textContent = courseName;
            });
        }

        // Edit military course modal
        const editMilitaryCourseModal = document.getElementById('editMilitaryCourseModal');
        if (editMilitaryCourseModal) {
            editMilitaryCourseModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const courseId = button.getAttribute('data-course-id');

                // In a real implementation, you would fetch the course details via AJAX
                // and populate the form fields
                document.getElementById('edit_military_course_id').value = courseId;

                // For demo purposes, we'll just set the ID
                // In a real app, you'd fetch the course details and populate all fields
            });
        }

        // Remove military course modal
        const removeMilitaryCourseModal = document.getElementById('removeMilitaryCourseModal');
        if (removeMilitaryCourseModal) {
            removeMilitaryCourseModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const courseId = button.getAttribute('data-course-id');

                document.getElementById('remove_military_course_id').value = courseId;
            });
        }

        // Remove certificate modal
        const removeCertificateModal = document.getElementById('removeCertificateModal');
        if (removeCertificateModal) {
            removeCertificateModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const certificateId = button.getAttribute('data-certificate-id');
                const courseName = button.getAttribute('data-course-name');

                document.getElementById('remove_certificate_id').value = certificateId;
                document.getElementById('remove_certificate_course').textContent = courseName;
            });
        }

        // Remove document modal
        const removeDocumentModal = document.getElementById('removeDocumentModal');
        if (removeDocumentModal) {
            removeDocumentModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const documentId = button.getAttribute('data-document-id');
                const documentName = button.getAttribute('data-document-name');

                document.getElementById('remove_document_id').value = documentId;
                document.getElementById('remove_document_name').textContent = documentName;
            });
        }

        // Status change handler for course status
        const editStatus = document.getElementById('edit_status');
        const completionDateField = document.getElementById('completion_date');

        if (editStatus && completionDateField) {
            editStatus.addEventListener('change', function() {
                if (this.value === 'completed') {
                    completionDateField.setAttribute('required', 'required');
                    completionDateField.parentElement.classList.add('required-field');
                } else {
                    completionDateField.removeAttribute('required');
                    completionDateField.parentElement.classList.remove('required-field');
                }
            });
        }

        // Calculate years in service from date of commission
        const dateOfCommission = document.getElementById('date_of_commission');
        const yearsInService = document.getElementById('years_in_service');

        if (dateOfCommission && yearsInService) {
            dateOfCommission.addEventListener('change', function() {
                if (this.value) {
                    const commissionDate = new Date(this.value);
                    const today = new Date();
                    let years = today.getFullYear() - commissionDate.getFullYear();

                    // Adjust if birthday hasn't occurred yet this year
                    if (today.getMonth() < commissionDate.getMonth() ||
                        (today.getMonth() === commissionDate.getMonth() && today.getDate() < commissionDate.getDate())) {
                        years--;
                    }

                    yearsInService.value = years;
                }
            });
        }
    });
</script>
{% endblock %}
