{% extends 'base.html' %}

{% block title %}Registration - Personal Information{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/registration/styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/registration/modern.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/registration/photo-preview.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="registration-card">
                <!-- Header -->
                <div class="card-header bg-military text-white">
                    <h2 class="text-center mb-0">Personal Information</h2>
                </div>

                <!-- Progress Steps -->
                <div class="px-4 pt-4">
                    <div class="progress-steps">
                        <div class="progress-step active">
                            <div class="step-number">1</div>
                            <div class="step-label">Personal Info</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-number">2</div>
                            <div class="step-label">Contact</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-number">3</div>
                            <div class="step-label">Social Media</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-number">4</div>
                            <div class="step-label">Next of Kin</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-number">5</div>
                            <div class="step-label">Education</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-number">6</div>
                            <div class="step-label">Military Training</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-number">7</div>
                            <div class="step-label">Review</div>
                        </div>
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="px-4 pt-3">
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <!-- Registration Form -->
                <form class="needs-validation" method="POST"
                      action="{{ url_for('main.registration_page_1') }}"
                      enctype="multipart/form-data" novalidate>

                    <!-- Military Information -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title mb-3">Military Information</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="service_number" class="form-label">
                                        Service Number <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                        <input type="text" class="form-control" id="service_number"
                                               name="service_number"
                                               value="{{ form_data.get('service_number', '') }}"
                                               placeholder="Enter your service number"
                                               required>
                                    </div>
                                    <div class="invalid-feedback">Service number is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="rank" class="form-label">
                                        Rank <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="rank" name="rank" required>
                                        <option value="">Select Rank</option>
                                        <!-- Non-Commissioned Ranks -->
                                        <optgroup label="Non-Commissioned Ranks">
                                            <option value="recruit" {% if form_data.get('rank') == 'recruit' %}selected{% endif %}>Recruit</option>
                                            <option value="private" {% if form_data.get('rank') == 'private' %}selected{% endif %}>Private</option>
                                            <option value="lance corporal" {% if form_data.get('rank') == 'lance corporal' %}selected{% endif %}>Lance Corporal</option>
                                            <option value="corporal" {% if form_data.get('rank') == 'corporal' %}selected{% endif %}>Corporal</option>
                                            <option value="sergeant" {% if form_data.get('rank') == 'sergeant' %}selected{% endif %}>Sergeant</option>
                                            <option value="staff sergeant" {% if form_data.get('rank') == 'staff sergeant' %}selected{% endif %}>Staff Sergeant</option>
                                            <option value="warrant officer" {% if form_data.get('rank') == 'warrant officer' %}selected{% endif %}>Warrant Officer</option>
                                            <option value="master warrant officer" {% if form_data.get('rank') == 'master warrant officer' %}selected{% endif %}>Master Warrant Officer</option>
                                            <option value="army warrant officer" {% if form_data.get('rank') == 'army warrant officer' %}selected{% endif %}>Army Warrant Officer</option>
                                        </optgroup>
                                        <!-- Commissioned Ranks -->
                                        <optgroup label="Commissioned Ranks">
                                            <option value="second lieutenant" {% if form_data.get('rank') == 'second lieutenant' %}selected{% endif %}>Second Lieutenant</option>
                                            <option value="lieutenant" {% if form_data.get('rank') == 'lieutenant' %}selected{% endif %}>Lieutenant</option>
                                            <option value="captain" {% if form_data.get('rank') == 'captain' %}selected{% endif %}>Captain</option>
                                            <option value="major" {% if form_data.get('rank') == 'major' %}selected{% endif %}>Major</option>
                                            <option value="lieutenant colonel" {% if form_data.get('rank') == 'lieutenant colonel' %}selected{% endif %}>Lieutenant Colonel</option>
                                            <option value="colonel" {% if form_data.get('rank') == 'colonel' %}selected{% endif %}>Colonel</option>
                                            <option value="brigadier general" {% if form_data.get('rank') == 'brigadier general' %}selected{% endif %}>Brigadier General</option>
                                            <option value="major general" {% if form_data.get('rank') == 'major general' %}selected{% endif %}>Major General</option>
                                            <option value="lieutenant general" {% if form_data.get('rank') == 'lieutenant general' %}selected{% endif %}>Lieutenant General</option>
                                            <option value="general" {% if form_data.get('rank') == 'general' %}selected{% endif %}>General</option>
                                        </optgroup>
                                    </select>
                                    <div class="invalid-feedback">Please select a rank</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="current_unit" class="form-label">Current Unit</label>
                                    <input type="text" class="form-control" id="current_unit"
                                           name="current_unit"
                                           value="{{ form_data.get('current_unit', '') }}"
                                           required>
                                    <div class="invalid-feedback">Current unit is required</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Details -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title mb-3">Personal Details</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="surname" class="form-label">
                                        Surname <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" class="form-control" id="surname"
                                               name="surname"
                                               value="{{ form_data.get('surname', '') }}"
                                               placeholder="Enter your surname"
                                               required>
                                    </div>
                                    <div class="invalid-feedback">Surname is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="other_names" class="form-label">
                                        Other Names <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                        <input type="text" class="form-control" id="other_names"
                                               name="other_names"
                                               value="{{ form_data.get('other_names', '') }}"
                                               placeholder="Enter your other names"
                                               required>
                                    </div>
                                    <div class="invalid-feedback">Other names are required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="date_of_birth" class="form-label">
                                        Date of Birth <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        <input type="date" class="form-control" id="date_of_birth"
                                               name="date_of_birth"
                                               value="{{ form_data.get('date_of_birth', '') }}"
                                               required>
                                    </div>
                                    <div class="invalid-feedback">Date of birth is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="gender" class="form-label">
                                        Gender <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-venus-mars"></i></span>
                                        <select class="form-select" id="gender" name="gender" required>
                                            <option value="">Select Gender</option>
                                            <option value="Male" {% if form_data.get('gender') == 'Male' %}selected{% endif %}>Male</option>
                                            <option value="Female" {% if form_data.get('gender') == 'Female' %}selected{% endif %}>Female</option>
                                        </select>
                                    </div>
                                    <div class="invalid-feedback">Please select a gender</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Information -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title mb-3">Service Information</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="date_of_commission" class="form-label">
                                        Date of Commission/Enlistment <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-check"></i></span>
                                        <input type="date" class="form-control" id="date_of_commission"
                                               name="date_of_commission"
                                               value="{{ form_data.get('date_of_commission', '') }}"
                                               required>
                                    </div>
                                    <div class="invalid-feedback">Date of commission/enlistment is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="years_in_service" class="form-label">
                                        Years in Service <span class="text-secondary">(Auto-calculated)</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                        <input type="number" class="form-control" id="years_in_service"
                                               name="years_in_service"
                                               value="{{ form_data.get('years_in_service', '') }}"
                                               readonly
                                               required>
                                    </div>
                                    <small class="text-muted">This value is calculated automatically from the Date of Commission/Enlistment</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="current_unit" class="form-label">
                                        Current Unit <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                                        <input type="text" class="form-control" id="current_unit"
                                               name="current_unit"
                                               value="{{ form_data.get('current_unit', '') }}"
                                               placeholder="Enter your current unit"
                                               required>
                                    </div>
                                    <div class="invalid-feedback">Current unit is required</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Photo Upload -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title mb-3">Passport Photograph</h4>
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="passport_photo" class="form-label">
                                            Upload Passport Photograph <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text"><i class="fas fa-camera"></i></span>
                                            <input type="file" class="form-control" id="passport_photo"
                                                   name="passport_photo" accept="image/png,image/jpeg,image/jpg" required>
                                        </div>
                                        <div class="invalid-feedback">Please upload a passport photograph</div>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle"></i> Accepted formats: JPG, JPEG, PNG. Max size: 2MB.
                                        </div>
                                        <div class="form-text">
                                            <i class="fas fa-exclamation-triangle text-warning"></i> Photo should be a recent passport-style photo with a plain background.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="photo-preview" id="photo-preview">
                                        <img id="preview-image" src="{{ url_for('static', filename='images/placeholder-user.png') }}"
                                             alt="Preview" class="img-fluid">
                                        <div class="photo-upload-hint">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                            <p>Your photo will appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="form-navigation">
                        <div></div> <!-- Empty div for flex spacing -->
                        <button type="submit" class="btn btn-military">
                            Next Step <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include the modern registration JavaScript -->
<script src="{{ url_for('static', filename='js/registration/modern.js') }}"></script>

<script>
// Photo preview enhancement
document.getElementById('passport_photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        const previewImage = document.getElementById('preview-image');
        const photoPreview = document.getElementById('photo-preview');
        const uploadHint = photoPreview.querySelector('.photo-upload-hint');

        reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';

            // Hide the upload hint when image is loaded
            if (uploadHint) {
                uploadHint.style.display = 'none';
            }

            // Add a loaded class for animation
            photoPreview.classList.add('loaded');
        }

        reader.readAsDataURL(file);
    }
});

// Calculate Years in Service automatically
document.getElementById('date_of_commission').addEventListener('change', function() {
    calculateYearsInService();
});

// Function to calculate years in service based on date of commission/enlistment
function calculateYearsInService() {
    const commissionDateInput = document.getElementById('date_of_commission');
    const yearsInServiceInput = document.getElementById('years_in_service');

    if (commissionDateInput.value) {
        const commissionDate = new Date(commissionDateInput.value);
        const today = new Date();

        // Calculate the difference in years
        let years = today.getFullYear() - commissionDate.getFullYear();

        // Adjust for months and days
        if (today.getMonth() < commissionDate.getMonth() ||
            (today.getMonth() === commissionDate.getMonth() && today.getDate() < commissionDate.getDate())) {
            years--;
        }

        // Set the calculated value
        yearsInServiceInput.value = years;

        // Add visual feedback
        yearsInServiceInput.classList.add('is-valid');
        setTimeout(() => {
            yearsInServiceInput.classList.remove('is-valid');
        }, 2000);
    } else {
        yearsInServiceInput.value = '';
    }
}

// Calculate years in service on page load if date is already set
window.addEventListener('DOMContentLoaded', function() {
    calculateYearsInService();

    // Add animation classes to cards
    document.querySelectorAll('.card').forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in');
    });
});
</script>
{% endblock %}
